<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Платежи</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .payment-row { display: flex; gap: 10px; padding: 6px; border-bottom: 1px solid #ddd; }
  .payment-row:hover, .payment-row:focus { background: #f0f8ff; outline: none; }
  .number { width: 30px; font-weight: bold; }
  .status { font-weight: bold; }
  #badgeCount { background: red; color: white; border-radius: 50%; padding: 4px 8px; font-size: 14px; vertical-align: middle; }
</style>
</head>
<body>

<h1>Платежи <span id="badgeCount">0</span></h1>

<div id="loading">Загрузка...</div>
<div id="error" style="color:red; display:none;">Ошибка загрузки данных</div>

<div id="paymentsBlock" style="display:none;">
  <div id="paymentsList"></div>
  <p id="totalSum">Общая сумма: 0</p>
  <p id="updatedAt">Обновлено: —</p>
</div>

<script>
const loadingEl = document.getElementById("loading");
const errorEl = document.getElementById("error");
const paymentsBlock = document.getElementById("paymentsBlock");
const paymentsList = document.getElementById("paymentsList");
const totalSumEl = document.getElementById("totalSum");
const badgeCountEl = document.getElementById("badgeCount");
const updatedAtEl = document.getElementById("updatedAt");

let paymentsData = [];
let lastUpdated = null;

async function fetchPayments() {
  loadingEl.style.display = "block";
  errorEl.style.display = "none";
  paymentsBlock.style.display = "none";

  try {
    // Замените URL на ваш реальный эндпоинт
    const response = await fetch("https://fastapi-myapp-production.up.railway.app/pending");
    if (!response.ok) throw new Error("Ошибка сети");
    const data = await response.json();

    // Ожидается, что data — массив массивов: [Название, Тип, №, Дата, Сумма, Статус]
    paymentsData = data;
    lastUpdated = new Date();

    renderPayments();
  } catch (err) {
    console.error(err);
    errorEl.style.display = "block";
  } finally {
    loadingEl.style.display = "none";
  }
}

function renderPayments() {
  if (!paymentsData.length) {
    paymentsList.innerHTML = "<p style='padding: 12px; color: #999;'>Нет ожидающих платежей.</p>";
    paymentsBlock.style.display = "block";
    totalSumEl.textContent = "Общая сумма: 0";
    badgeCountEl.textContent = "0";
    updatedAtEl.textContent = "Обновлено: —";
    return;
  }

  let sum = 0;
  let awaitingCount = 0;
  paymentsList.innerHTML = "";

  paymentsData.forEach((row, idx) => {
    // row: [Название, Тип, №, Дата, Сумма, Статус]
    const div = document.createElement("div");
    div.className = "payment-row";
    div.tabIndex = 0;
    div.setAttribute("role", "button");
    div.setAttribute("aria-label", `Платёж ${row[0]} №${row[2]}, сумма ${row[4]}, статус ${row[5]}`);

    div.innerHTML = `
      <div class="number">${idx + 1}</div>
      <div>${row[0]}</div>
      <div>${row[1]}</div>
      <div>${row[3]}</div>
      <div>${row[4]}</div>
      <div class="status">${row[5]}</div>
    `;
    paymentsList.appendChild(div);

    if (row[5].toLowerCase() === "ожидает") {
      sum += +row[4];
      awaitingCount++;
    }
  });

  totalSumEl.textContent = "Общая сумма: " + sum.toLocaleString("ru-RU");
  badgeCountEl.textContent = awaitingCount;
  updatedAtEl.textContent = "Обновлено: " + lastUpdated.toLocaleTimeString("ru-RU");
  paymentsBlock.style.display = "block";
}

// Запуск загрузки при загрузке страницы
fetchPayments();
</script>

</body>
</html>
